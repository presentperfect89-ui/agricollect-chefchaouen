<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgriCollect Chefchaouen - Dashboard</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://cdn.jsdelivr.net/npm/gridjs/dist/theme/mermaid.min.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        #map { height: 500px; width: 100%; border-radius: 1.5rem; border: 4px solid white; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); z-index: 1; }
        .glass-card { background: white; border-radius: 1.5rem; border: 1px solid #e2e8f0; }
        .popup-img { width: 100%; max-width: 200px; height: 130px; object-fit: cover; border-radius: 8px; margin-top: 8px; border: 1px solid #ddd; }
        .gridjs-search-input { border-radius: 12px !important; border: 2px solid #f1f5f9 !important; width: 250px !important; }
    </style>
</head>
<body class="bg-slate-50 p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="mb-8 flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-3xl font-black text-slate-900 tracking-tight">AgriCollect <span class="text-green-600">Chefchaouen</span></h1>
                <p class="text-slate-500 font-bold text-xs uppercase tracking-widest mt-1">Made by MAKRANE</p>
            </div>
            <button onclick="location.reload()" class="bg-green-600 text-white px-8 py-3 rounded-2xl font-bold hover:bg-green-700 transition shadow-lg">
                Actualiser
            </button>
        </header>

        <div class="grid grid-cols-1 gap-8">
            <div id="map"></div>
            <div class="glass-card p-6 shadow-xl overflow-hidden">
                <div id="table-container"></div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gridjs/dist/gridjs.umd.js"></script>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbxKqb5_sUmBOJYW5SNJypywFQ9_Ij4hxtm7jBTwRULX1jrpf7jpeX-j1ndjgYT8137xKA/exec";

        const map = L.map('map').setView([35.17, -5.27], 10);
        L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}').addTo(map);

        // --- CORRECTION PHOTO ---
function getDirectImgUrl(url) {
    if (!url || url === "" || url === "undefined") return null;
    let id = "";
    if (url.includes("id=")) { id = url.split("id=")[1].split("&")[0]; }
    else if (url.includes("/d/")) { id = url.split("/d/")[1].split("/")[0]; }
    
    // Utilisation du lien "thumbnail" (miniature) avec une grande taille
    // C'est le lien le plus stable pour contourner les blocages de navigateur
    return id ? `https://lh3.googleusercontent.com/d/${id}=s800` : null;
}

        async function init() {
            try {
                const response = await fetch(API_URL, { method: 'GET', redirect: 'follow' });
                const data = await response.json();

                data.forEach(item => {
                    if (item.latitude && item.longitude) {
                        const imgUrl = getDirectImgUrl(item.lienphoto);
                        
                        // --- CORRECTION DATE DANS POPUP ---
                        let d = new Date(item.timestamp);
                        let datePopup = !isNaN(d.getTime()) ? d.toLocaleDateString('fr-FR') : item.timestamp;

                        let popupHTML = `
                            <div style="min-width:160px">
                                <b style="color:#16a34a">${item.culture || 'Culture'}</b><br>
                                <small>Le ${datePopup} par ${item.nomcollecteur}</small><br>
                                ${imgUrl ? `<img src="${imgUrl}" class="popup-img" onerror="this.src='https://placehold.co/200x130?text=Photo+Privee'">` : ''}
                            </div>`;
                        L.marker([item.latitude, item.longitude]).addTo(map).bindPopup(popupHTML);
                    }
                });

                // --- CORRECTION TABLEAU + DATES ---
                new gridjs.Grid({
                    columns: [
                        { 
                            name: "Date", 
                            sort: {
                                compare: (a, b) => {
                                    const parse = (s) => new Date(s.split('/').reverse().join('-'));
                                    return parse(a) - parse(b);
                                }
                            }
                        },
                        "Collecteur", "Culture", "Surface", "Notes"
                    ],
                    data: data.map(i => {
                        let d = new Date(i.timestamp);
                        // Si la date JS échoue, on prend le texte brut
                        let dateFinal = !isNaN(d.getTime()) ? d.toLocaleDateString('fr-FR') : (i.timestamp || "—");
                        
                        return [
                            dateFinal, 
                            i.nomcollecteur || "—", 
                            i.culture || "—", 
                            (i.superficieha || "0") + " Ha", 
                            i.notes || "—"
                        ];
                    }),
                    search: true,
                    pagination: { limit: 10 },
                    sort: true,
                    style: { table: { fontSize: '13px' } }
                }).render(document.getElementById("table-container"));

            } catch (err) { console.error(err); }
        }
        init();
    </script>
</body>
</html>

